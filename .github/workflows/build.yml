name: Build & Release OBS Plugin

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest

    steps:
    # ===============================
    # 1. Checkout 插件源码
    # ===============================
    - name: Checkout plugin
      uses: actions/checkout@v4

    # ===============================
    # 2. Checkout OBS Studio（必须完整 + tags）
    # ===============================
    - name: Checkout OBS Studio
      uses: actions/checkout@v4
      with:
        repository: obsproject/obs-studio
        path: obs-studio
        fetch-depth: 0
        fetch-tags: true

    # ===============================
    # 3. MSVC 环境
    # ===============================
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    # ===============================
    # 4. 配置 OBS（强制版本，避免 git/version 崩溃）
    # ===============================
    - name: Configure OBS
      shell: cmd
      run: |
        cmake -S obs-studio -B obs-studio\build ^
          -DOBS_VERSION_OVERRIDE=30.1.2 ^
          -DENABLE_UI=OFF ^
          -DENABLE_SCRIPTING=OFF ^
          -DENABLE_PLUGINS=OFF ^
          -DCMAKE_BUILD_TYPE=Release

    # ===============================
    # 5. 构建 OBS（生成 libobs）
    # ===============================
    - name: Build OBS
      shell: cmd
      run: |
        cmake --build obs-studio\build --config Release

    # ===============================
    # 6. vcpkg（如果仓库包含 vcpkg.json，先安装依赖）
    # ===============================
    - name: Setup vcpkg (manifest)
      uses: lukka/run-vcpkg@v11
      with:
        runVcpkgInstall: true
        vcpkgJsonGlob: "vcpkg.json"

    # ===============================
    # 7. 配置插件（使用 vcpkg toolchain）
    # ===============================
    - name: Configure Plugin
      shell: cmd
      run: |
        cmake -S . -B build ^
          -DOBS_SOURCE_DIR=%CD%\obs-studio ^
          -DCMAKE_TOOLCHAIN_FILE=%CD%\vcpkg\scripts\buildsystems\vcpkg.cmake ^
          -DCMAKE_BUILD_TYPE=Release

    # ===============================
    # 7. 构建插件
    # ===============================
    - name: Build Plugin
      shell: cmd
      run: |
        cmake --build build --config Release

    # ===============================
    # 8. 打包（OBS 插件标准结构）
    # ===============================
    - name: Package
      shell: cmd
      run: |
        mkdir package
        mkdir package\bilibili-live
        copy build\Release\bilibili-live.dll package\bilibili-live\

    # ===============================
    # 9. 发布 GitHub Release
    # ===============================
    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        files: package/**
